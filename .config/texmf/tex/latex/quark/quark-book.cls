\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{quark-book}

\RequirePackage{kvoptions}
\SetupKeyvalOptions {
  family=quark,
  prefix=quark@,
}

% Extra formatting to exclude from more formal documents
\DeclareOption{extras}{\AtEndOfPackage{\RequirePackage{quark-extras}}}

% If true, number theorems by subsection instead of section
\DeclareBoolOption{long}

\DeclareOption*{\PassOptionsToClass{\CurrentOption}{scrbook}}
\DeclareDefaultOption{\PassOptionsToClass{\CurrentOption}{scrbook}}
\ProcessOptions\relax
\ProcessKeyvalOptions*
\LoadClass[reqno]{scrbook}

\RequirePackage[margin=1in]{geometry}  % Not really narrower, but more symmetric
\RequirePackage{amsmath, amssymb, amsthm}
\RequirePackage{hyperref}
\RequirePackage{xcolor}
\RequirePackage{xparse}
\RequirePackage{quark-colours}

% Requires LuaTeX or XeTeX.
\RequirePackage{unicode-math}  % Fix incorrect rendering of =>
\RequirePackage{fontspec}
\setmainfont{ETbb}
\newfontfamily\symbolsfont{Symbola}

% See https//www.khirevich.com/latex/microtype/
\RequirePackage[
    %, stretch  = 10, shrink = 10         % Variation of character width (default 20)
]{microtype}
\SetProtrusion{encoding={*},family={bch},series={*},size={6,7}}
              {1={ ,750},2={ ,500},3={ ,500},4={ ,500},5={ ,500},
               6={ ,500},7={ ,600},8={ ,500},9={ ,500},0={ ,500}}

% Cleveref must be loaded after amsthm and hyperref, but before any theorem environment definitions.
% If a version of the source is needed without the cleveref dependency,a sed script to hardcode its
% effects can be generated by passing the 'poorman' option.
\RequirePackage[capitalise,nameinlink,noabbrev]{cleveref}

\ifquark@long
  \newtheorem{theorem}{Theorem}[subsection]
\else
  \newtheorem{theorem}{Theorem}[section]
\fi

%\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition} \newtheorem{definition}[theorem]{Definition}
\theoremstyle{remark} \newtheorem*{remark}{Remark}