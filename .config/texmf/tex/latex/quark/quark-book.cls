\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{quark-book}

\LoadClass[reqno]{scrbook}
\RequirePackage[margin=1in]{geometry}

\RequirePackage{kvoptions}
\SetupKeyvalOptions {
  family=quark,
  prefix=quark@,
}

% Extra formatting to exclude from more formal documents
\DeclareBoolOption{extras}

\DeclareOption*{\PassOptionsToClass{\CurrentOption}{scrbook}}
\DeclareDefaultOption{\PassOptionsToClass{\CurrentOption}{scrbook}}
\ProcessOptions\relax
\ProcessKeyvalOptions*

\addtokomafont{disposition}{\normalfont\bfseries}

%\RequirePackage{thmtools}
%\RequirePackage{etoolbox}
%\RequirePackage{xcolor}
%\RequirePackage{xparse}

% \RequirePackage{expl3}
% \ExplSyntaxOn
% \int_new:N \g__um_prime_font_cmd_tl
% \ExplSyntaxOff

\usepackage{robust-externalize}

% It seems this option is not currently recognised?
% \robExtConfigure{
%   compile in parallel after=4,
% }

% Use from v2.3
%\runHereAndInPreambleOfCachedFiles{...}
% Otherwise:
\robExtConfigure{
  add to preset={latex}{
    add to preamble={
      \RequirePackage{iftex}
      \iftutex
        % Haven't yet found how to fix missing \lrcorner character
        % Says it's missing in Latin Modern, but present when using pdflatex
        \RequirePackage{fontspec}
        \setmainfont{ETbb}
        \setmathfont{Latin Modern Math}
        \newfontfamily\symbolsfont{Symbola}
      \else
        \usepackage[T1]{fontenc}
        \RequirePackage[full]{textcomp} % Seems necessary for certain fonts
        \RequirePackage{lmodern}
        \RequirePackage{ETbb}
      \fi
    }
  },
}

\RequirePackage{iftex}
\iftutex
  % Haven't yet found how to fix missing \lrcorner character
  % Says it's missing in Latin Modern, but present when using pdflatex
  \RequirePackage{fontspec}
  \setmainfont{ETbb}
  \setmathfont{Latin Modern Math}
  \newfontfamily\symbolsfont{Symbola}
\else
  \usepackage[T1]{fontenc}
  \RequirePackage[full]{textcomp} % Seems necessary for certain fonts
  \RequirePackage{lmodern}
  \RequirePackage{ETbb}
\fi

\RequirePackage[british]{babel}
\RequirePackage[
  backref = true,
  maxnames = 4,
  maxalphanames = 4,
  style = alphabetic,
] {biblatex}

% See https//www.khirevich.com/latex/microtype
\RequirePackage[
    %, stretch  = 10, shrink = 10         % Variation of character width (default 20)
]{microtype}
\SetProtrusion{encoding={*},family={bch},series={*},size={6,7}}
              {1={ ,750},2={ ,500},3={ ,500},4={ ,500},5={ ,500},
               6={ ,500},7={ ,600},8={ ,500},9={ ,500},0={ ,500}}

\RequirePackage{amsmath,amsthm}
\RequirePackage{thmtools}

% Should be imported after most other packages
\RequirePackage{hyperref}

% Cleveref must be loaded after amsthm and hyperref, but before any theorem environment definitions.
% If a version of the source is needed without the cleveref dependency, a sed script to hardcode its
% effects can be generated by passing the 'poorman' option.
\RequirePackage[capitalise,noabbrev]{cleveref}
\creflabelformat{equation}{#2\textup{#1}#3}

\declaretheorem{theorem}[parent=section]
\declaretheorem{proposition, lemma, corollary}[sibling=theorem]
\declaretheorem{definition}[style=definition, sibling=theorem]
\declaretheorem{remark}[style=remark, numbered=no]

\declaretheorem{eg}[
  style=definition,
  sibling=theorem,
  name=Example,
  % Cleveref's 'capitalise' argument does nothing when refname is defined
  refname={Example, Examples},
]

\RequirePackage{quark-macros}
\ifquark@extras
  \RequirePackage{quark-extras}
\fi

% Make maths match the boldness of the surrounding text
% https://tex.stackexchange.com/a/124311
% Note: egreg's answer to the same question looks more targetted, and may end up being preferable if I want to avoid bold maths in bold body text. But I doubt I'll ever want maths in bold body text anyway.
\makeatletter
\g@addto@macro\bfseries{\boldmath}
\makeatother

% From https://tex.stackexchange.com/a/53091
%\NewDocumentCommand{\ifempty}{mmm}{%
%    \setbox0=\hbox{#1\unskip}\ifdim\wd0=0pt
%      #2%
%    \else
%      #3%
%    \fi
%  }
%
%\newtheoremstyle{break}%
%  {\topsep}{\topsep}% space above and below
%  {}{}% body font style
%  {\bfseries}{}% head font style
%  { }% space after head (leaving this emoty causes a missing number error)
%  {\thmname{#1}\thmnumber{ #2}\ifempty{#3}{.}{: }\thmnote{\the\thm@notefont#3\\[5pt]}}
