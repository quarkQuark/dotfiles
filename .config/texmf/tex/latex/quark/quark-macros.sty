\ProvidesPackage{quark-macros}

\RequirePackage{kvoptions}
\SetupKeyvalOptions {
  family=quark,
  prefix=quark@,
}

\DeclareBoolOption{unicode}
\DeclareStringOption[fig]{tikzDir}[fig]
\ProcessKeyvalOptions*

% Should be loaded before unicode-math and fontspec
\RequirePackage{mathtools}  % Includes amsmath
\RequirePackage{amssymb, amsthm}

\RequirePackage{xcolor}
\RequirePackage{xparse}
%\RequirePackage{etoolbox}
%\RequirePackage{kvoptions}
%\RequirePackage{leftindex}
\RequirePackage{graphicx}
\RequirePackage{dsfont}
\RequirePackage{environ}

\RequirePackage{tikz}
\usetikzlibrary{cd}

\RequirePackage{iftex}
\iftutex
  \RequirePackage{unicode-math}  % Fixes incorrect rendering of =>
  \NewDocumentCommand {\mybold} {m} {\symbfup{#1}}
  % Tell unicode-math to revert to the standard font for \mathcal
  \DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}
\else
  \RequirePackage{bm}  % Incompatible with unicode-math
  \NewDocumentCommand {\mybold} {m} {\bm{#1}}
\fi

% \ifquark@unicode
%   % Requires lualatex or xelatex
%   \RequirePackage{unicode-math}  % Fixes incorrect rendering of =>
%   \NewDocumentCommand {\mybold} {m} {\symbfup{#1}}
%   % Tell unicode-math to revert to the standard font for \mathcal
%   \DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}
% \else
%   \RequirePackage{bm}  % Incompatible with unicode-math
%   \NewDocumentCommand {\mybold} {m} {\bm{#1}}
% \fi

\newcommand{\inputtikz}[1]{%
  \tikzsetnextfilename{#1}% Don't recompile if moved in document
  \input{\expandonce{\quark@tikzDir}/#1.tikz}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Make tikz-cd work with externalisation
% From https://tex.stackexchange.com/a/362104

\def\temp{&} \catcode`&=\active \let&=\temp

\newcommand{\mytikzcdcontext}[2]{
  \begin{tikzpicture}[baseline=(maintikzcdnode.base)]
    \node (maintikzcdnode) [inner sep=0, outer sep=0] {\begin{tikzcd}[#2]
        #1
    \end{tikzcd}};
  \end{tikzpicture}}

\NewEnviron{cd}[1][]{%
  % In the following, we need \BODY to expanded before \mytikzcdcontext
  % such that the md5 function gets the tikzcd content with \BODY expanded.
  % Howerver, expand it only once, because the \tikz-macros aren't
  % defined at this point yet. The same thing holds for the arguments to
  % the tikzcd-environment.
  \def\myargs{#1}%
  \edef\mydiagram{\noexpand\mytikzcdcontext{\expandonce\BODY}{\expandonce\myargs}}%
  \mydiagram%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{tikzcdbox}
    {\begin{lrbox}{\tikzcdboxbox}\begin{tikzcd}}
    {\end{tikzcd}\end{lrbox}\fbox{\usebox{\tikzcdboxbox}}}
\newsavebox{\tikzcdboxbox}

% Apply #1 to only the capital letters in #2
% From https://tex.stackexchange.com/a/173261
\ExplSyntaxOn
\NewDocumentCommand {\oncaps} {mm} {\quark_oncaps:nn{#1}{#2}}
\tl_new:N \l__quark_oncaps_input_tl
\cs_new_protected:Npn \quark_oncaps:nn #1 #2
 {
  % store the string in a variable
  \tl_set:Nn \l__quark_oncaps_input_tl { #2 }
  \regex_replace_all:nnN
    % search a capital letter (or more)
    { ([A-Z]+|\cC.\{?[A-Z]+\}?) }
    % replace the match with \textcolor{#1}{<match>}
    { \c{#1}\cB\{\1\cE\} }
    \l__quark_oncaps_input_tl
  \tl_use:N \l__quark_oncaps_input_tl
 }
\ExplSyntaxOff

%\newcommand{\eqtag}[1]{\stepcounter{equation}\tag{\theequation}\label{#1}}
%\newcommand{\dd}{\,\mathrm{d}}
%\DeclareDocumentCommand{\pder}{ O{} O{} m }{\frac{\partial^{#2}#1}{\partial#3^{#2}}}

% Group actions
\NewDocumentCommand {\lact} {mm} {\prescript{#1}{}{#2}} % Left action
\DeclareMathOperator {\Ad}   {Ad}                       % Adjoint action
\DeclareMathOperator {\Orb}  {Orb}                      % Orbit
\DeclareMathOperator {\Stab} {Stab}                     % Stabiliser

%\NiceMatrixOptions{cell-space-limits = 1pt}
\NewDocumentCommand {\mat} {m} {\begin{pmatrix}#1\end{pmatrix}}
\DeclareMathOperator {\Mat}  {Mat}
\DeclareMathOperator {\GL}   {GL}
\DeclareMathOperator {\tr}   {tr} % Trace
\DeclareMathOperator {\rank} {rank}

% Correct spacing for multicharacter names of maps and morphisms
% See https://tex.stackexchange.com/questions/16649/too-small-space-when-using-declaremathoperator
% Adds small spacing on left, none at all on right (so no right-multiplication by scalars)
% Zero spacing on right is necessary to stop \circ, \otimes etc from becoming unary
\NewDocumentCommand {\mathmap} {m} {\mathop{}\mathopen{}#1}

% Helpers
\DeclareMathSymbol  {\dash}      {\mathord}{AMSa}{"39} % Hyphen (not minus) (\hyphen is taken by cleveref)
\NewDocumentCommand {\IfTsub}  {o}  {\IfValueT{#1}{_{#1}}}
\NewDocumentCommand {\IfTsup}  {o}  {\IfValueT{#1}{^{#1}}}
\NewDocumentCommand {\IfTpre}  {o}  {\IfValueT{#1}{#1\dash}}
%\NewDocumentCommand {\IfTcomma} {o}  {\IfValueT{#1}{,}}
\NewDocumentCommand {\IfTlist} {oo} {%
  \IfValueTF{#1}{%
    \IfValueTF{#2}{#1,#2}{#1}
  }{%
    \IfValueTF{#2}{#2}{}%
  }%
}

% Formatting of category names
\NewDocumentCommand {\cat}   {m} {\mathcal{#1}}                  % Arbitrary category
\NewDocumentCommand {\scat}  {m} {\mybold{#1}}                   % Arbitrary small category
\NewDocumentCommand {\ccat}  {m} {\mathbb{#1}}                   % Arbitrary 2-category
\NewDocumentCommand {\fcat}  {m} {\mathrm{#1}}                   % Fixed category
\NewDocumentCommand {\fccat} {m} {\mathrm{\oncaps{mathbb}{#1}}}  % Fixed 2-category

% Common symbols
\NewDocumentCommand {\demph}   {m}    {\textbf{#1}}    % Emphasis for terms being defined
\NewDocumentCommand {\field}   {O{k}} {\mathds{#1}}
\NewDocumentCommand {\two}     {m}    {\mybold{{#1}}}  % 2-functor or 2-natural transformation
\NewDocumentCommand {\st}        { } {:}                                    % Separator when defining sets
\NewDocumentCommand {\from}      { } {{\colon}\linebreak[0]}                % Colon for f: A --> B
\NewDocumentCommand {\iso}       { } {\cong}                                % Isomorphism
\NewDocumentCommand {\of}        { } {\mathbin{\circ}}                      % Composition
\NewDocumentCommand {\eqv}       { } {\simeq}                               % Equivalence
\NewDocumentCommand {\unit}      { } {\mathds{1}}                           % Unit (identity object)
\NewDocumentCommand {\uunit}     { } {\cat{I}}                              % Unit in a 2-cat
\NewDocumentCommand {\id}        {o} {\mathmap{\mathrm{id}\IfTsub[#1]}}     % Identity morphism or nat
\NewDocumentCommand {\iid}       {o} {\mathmap{\two{id}\IfTsub[#1]}}        % Identity 2-nat
\NewDocumentCommand {\mapsot}    { } {\mathrel{\reflectbox{\ensuremath{\mapsto}}}}
\NewDocumentCommand {\subnormal} { } {\triangleleft}                        % Normal subgroup

% Standard functors
\NewDocumentCommand {\Res}   {} {\mathrm{Res}}   % Restriction
\NewDocumentCommand {\Ind}   {} {\mathrm{Ind}}   % Induction
\NewDocumentCommand {\Coind} {} {\mathrm{Coind}} % Coinduction

% Standard sets
\DeclareMathOperator {\Nil}    {Nil}    % Nilpotent elements
\DeclareMathOperator {\Hom}    {Hom}    % Homset
\DeclareMathOperator {\Lin}    {Lin}    % Space of linear maps
\DeclareMathOperator {\Nat}    {Nat}    % Natural transformations
\DeclareMathOperator {\End}    {End}    % Endomorphisms
\DeclareMathOperator {\Coend}  {Coend}  % Coend construction
\DeclareMathOperator {\Aut}    {Aut}    % Automorphisms
\DeclareMathOperator {\Span}   {Span}   % Automorphisms
\DeclareMathOperator {\Ob}     {Ob}     % Objects
\DeclareMathOperator {\Mor}    {Mor}    % Morphisms
\DeclareMathOperator {\Fun}    {Fun}    % Functors
\DeclareMathOperator {\MonFun} {MonFun} % Monoidal functors
\DeclareMathOperator {\FFun}   {2Fun}   % 2-functors
\NewDocumentCommand {\PSFun} {o} {\Fun^{ps}\IfTsub[#1]} % Pseudofunctors

% Fixed categories
\NewDocumentCommand {\Set}     {  } {\fcat{Set}}                           % Sets
\NewDocumentCommand {\Ab}      {  } {\fcat{Ab}}                            % Abelian groups
\NewDocumentCommand {\Grp}     {  } {\fcat{Grp}}                           % Groups
\NewDocumentCommand {\GGrp}    {  } {\fcat{2Grp}}                          % 2-Groups
\NewDocumentCommand {\Grpd}    {  } {\fcat{Grpd}}                          % Groupoids
\NewDocumentCommand {\XMod}    {  } {\fcat{XMod}}                          % Crossed modules
\NewDocumentCommand {\Ring}    {  } {\fcat{Ring}}                          % Rings
\NewDocumentCommand {\CRing}   {  } {\fcat{CRing}}                         % Commutative rings
\NewDocumentCommand {\Mon}     {  } {\fcat{Mon}}                           % Monoids
\NewDocumentCommand {\CMon}    {  } {\fcat{CMon}}                          % Commutative monoids
\NewDocumentCommand {\Alg}     {  } {\fcat{Alg}}                           % Algebras
\NewDocumentCommand {\CAlg}    {  } {\fcat{CAlg}}                          % Commutative algebras
\NewDocumentCommand {\Tp}      {  } {\fcat{Top}}                           % Topological spaces
\NewDocumentCommand {\Chain}   {m } {\fcat{Ch}_{\bullet}(#1)}              % Chain complexes in #1
\NewDocumentCommand {\Cochain} {m } {\fcat{Ch}^{\bullet}(#1)}              % Chain complexes in #1
\NewDocumentCommand {\Mod}     {oo} {\IfTpre[#1]\fcat{Mod}   \IfTsup[#2]}  % #1-modules
\NewDocumentCommand {\Comod}   {oo} {\IfTpre[#1]\fcat{Comod} \IfTsup[#2]}  % #1-comodules
\NewDocumentCommand {\Vect}    {oo} {\IfTpre[#1]\fcat{Vect}  \IfTsup[#2]}  % #1-vector spaces
\NewDocumentCommand {\Rep}     {oo} {\fcat{Rep}\IfTsub[#1]   \IfTsup[#2]}  % Representations of #1
\NewDocumentCommand {\Gray}    {  } {\fcat{Gray}}

% Fixed categories based on Mod and Vect
\NewDocumentCommand {\GMod}     {oom } {   \Mod[#1][#2]_{#3}}                    % Graded
\NewDocumentCommand {\SVect}    {oo  } {\IfTpre[#1]\fcat{SVect}\IfTsup[#2]}      % Super
\NewDocumentCommand {\GVect}    {oom } {  \Vect[#1][#2]_{#3}}                    % Graded
\NewDocumentCommand {\GVectco}  {oomm} { \GVect[#1][\IfTlist[#4  ][#2]] {#3}} % Graded
\NewDocumentCommand {\lGVect}   {oom } { \GVect[#1][\IfTlist[\ell][#2]] {#3}} % Left-Hom-graded
\NewDocumentCommand {\rGVect}   {oom } { \GVect[#1][\IfTlist[r   ][#2]] {#3}} % Right-Hom-graded
\NewDocumentCommand {\Vectskel} {oo  } {  \Vect[#1][\IfTlist[sk  ][#2]]     } % Skeleton

% Finite-dimensional variants
\NewDocumentCommand {\FMod}      {oo  } {   \Mod  [#1] [\IfTlist[fd][#2]]     }
\NewDocumentCommand {\FGMod}     {oom } {  \GMod  [#1] [\IfTlist[fd][#2]] {#3}}
\NewDocumentCommand {\FComod}    {oo  } { \Comod  [#1] [\IfTlist[fd][#2]]     }
\NewDocumentCommand {\FVect}     {oo  } {  \Vect  [#1] [\IfTlist[fd][#2]]     }
\NewDocumentCommand {\FRep}      {oo  } {  \Rep   [#1] [\IfTlist[fd][#2]]     }
\NewDocumentCommand {\FGVect}    {oom } { \GVect  [#1] [\IfTlist[fd][#2]] {#3}}
\NewDocumentCommand {\FGVectco}  {oomm} { \GVectco[#1] [\IfTlist[fd][#2]] {#3}{#4}}
\NewDocumentCommand {\lFGVect}   {oom } {\lGVect  [#1] [\IfTlist[fd][#2]] {#3}}
\NewDocumentCommand {\rFGVect}   {oom } {\rGVect  [#1] [\IfTlist[fd][#2]] {#3}}
\NewDocumentCommand {\FVectskel} {oo  } {\Vectskel[#1] [\IfTlist[fd][#2]]     }

% Fixed bicategories
\NewDocumentCommand {\Cat}    {  } {\fccat{Cat}}                        % Categories
\NewDocumentCommand {\Enrich} {m} {#1\dash\Cat}                  % #1-enriched categories
\NewDocumentCommand {\FACat}  {o } {\IfTpre[#1]\Cat^{fa}}               % Finite abelian
\NewDocumentCommand {\ModCat} {m } {#1\dash\fccat{ModCat}}              % Module categories
\NewDocumentCommand {\VVect}  {o } {\IfTpre[#1]\fccat{2Vect}}           % 2-vector spaces
\NewDocumentCommand {\GVVect} {mo} {\IfTpre[#2]\fccat{2Vect}_{#1}}      % Graded 2-vector spaces
\NewDocumentCommand {\RRep}   {o } {\fccat{2Rep}\IfTsub[#1]}            % 2-representations
\NewDocumentCommand {\Bimod}  {  } {\fccat{Bimod}}                      % Bimodules
\NewDocumentCommand {\GCat}   {mo} {\Cat_{#1}\IfTsup[#2]}               % Graded categories
\NewDocumentCommand {\HGCat}  {mo} {\Cat^{\IfTlist[#1][#2]}}            % Hom-graded categories
\NewDocumentCommand {\GCatS}  {mo} {\GCat {#1}[\IfTlist[#2][\langle - \rangle]]} % with shifts
\NewDocumentCommand {\HGCatS} {mo} {\HGCat{#1}[\IfTlist[#2][\langle - \rangle]]} % with shifts
% deprecated
\NewDocumentCommand {\Graded}     {om} {\fccat{Cat}_{#2}\IfTsup[#1]}        % Graded categories
\NewDocumentCommand {\HomGraded}  {om} {\fccat{Cat}^{\IfTlist[#2][#1]}}  % Hom-graded categories
\NewDocumentCommand {\GradedS}    {om} {\Graded   [\IfTlist[#1][\langle - \rangle]]{#2}} % with shifts
\NewDocumentCommand {\HomGradedS} {om} {\HomGraded[\IfTlist[#1][\langle - \rangle]]{#2}} % with shifts

% Category theoretic constructions
\DeclareMathOperator {\op}         {op}                           % Opposite category
\NewDocumentCommand  {\lt}     {m} {\lim\limits_{\leftarrow #1}}  % Limit
\NewDocumentCommand  {\colt}   {m} {\lim\limits_{\rightarrow #1}} % Colimit
\DeclareMathOperator {\eq}         {eq}                           % Equaliser
\DeclareMathOperator {\coeq}       {coeq}                         % Coequaliser
\DeclareMathOperator {\coker}      {coker}                        % Cokernel
\DeclareMathOperator {\im}         {im}                           % Image
\DeclareMathOperator {\coim}       {coim}                         % Coimage
\NewDocumentCommand  {\eval}   { } {\mathmap{\mathrm{ev}}}        % Evaluation morphism
\NewDocumentCommand  {\coeval} { } {\mathmap{\mathrm{coev}}}      % Coevaluation morphism
\NewDocumentCommand  {\centre} {m} {\cat{Z}(#1)}                  % Centre construction
\NewDocumentCommand  {\deloop} { } {\mathbf{B}}                   % Delooping (I don't want operator spacing)
\DeclareMathOperator {\Disc}       {Disc}                         % Discrete categorification

\NewDocumentCommand {\pb} {oo} % Pullback
  % From https://tex.stackexchange.com/questions/305755/pullback-symbol-of-morphisms
  {\mathbin{%
      {}_{\IfValueTF{#1}{#1}{s}}%
      \kern-\scriptspace{\times}%
      _{\IfValueTF{#2}{#2}{t}}}}
  
% Optionally labelled rightarrow; should be indistinguishable from default \to when no argument
% Bug: \to works as it should, but \to[] is slightly longer.
\RenewDocumentCommand {\to} {!o} {\IfValueTF{#1}{\xlongrightarrow{#1}}{\rightarrow}}
\NewDocumentCommand   {\ot} {!o} {\IfValueTF{#1}{\xlongleftarrow{#1}}{\leftarrow}}

% Double arrows for natural transformations (requires mathtools)
\NewDocumentCommand {\arrowarg} {o} {\IfValueTF{#1}{\,\,#1\,\,}{}}
\NewDocumentCommand {\tonat} {O{}} {\xRightarrow{\arrowarg{#1}}}
\NewDocumentCommand {\otnat} {O{}} {\xLeftarrow{\arrowarg{#1}}}

% Isomorphism arrows (defined without \to or \ot to avoid extra space)
\NewDocumentCommand {\toiso}  {} {\xrightarrow{\sim}}
\NewDocumentCommand {\otiso}  {} {\xleftarrow{\sim}}
\NewDocumentCommand {\natiso} {} {\xRightarrow{\sim}}
\NewDocumentCommand {\taniso} {} {\xLeftarrow{\sim}}

% Double-headed arrows for epimorphisms and surjections
\NewDocumentCommand {\toepi}  {O{}} {%
  \mathrel{\ooalign{\(\to[#1\mkern4mu]\)\cr\hidewidth\(\rightarrow\mkern4mu\)}}
}
\NewDocumentCommand {\otepi}  {O{}} {\mathrel{\reflectbox{\ensuremath{\toepi[\reflectbox{#1}]}}}}

% Hooked arrows for monomorphisms and injections
\NewDocumentCommand {\tomono}  {O{}} {\xhookrightarrow{#1}}
\NewDocumentCommand {\otmono}  {O{}} {\xhookleftarrow{#1}}

% Deprecated
\NewDocumentCommand {\Gr} {} {\fcat{Grp}}
\newcommand{\toby}[1]{\to[#1]}
\newcommand{\otby}[1]{\ot[#1]}
\newcommand{\incl}{\tomono}
\newcommand{\simto}{\xrightarrow{\sim}}

% Semantic arrows in tikzcd
\NewDocumentCommand {\epi}      {O{}}   {\ar[twoheadrightarrow,#1]}
\NewDocumentCommand {\mono}     {O{}}   {\ar[hook,#1]}
\NewDocumentCommand {\epimono}  {O{}}   {\ar[twoheadrightarrow,hook,#1]}
\NewDocumentCommand {\univ}     {O{}}   {\ar[dotted,#1]}
\NewDocumentCommand {\equal}    {O{}}   {\ar[equal,#1]}
\NewDocumentCommand {\nat}      {O{}}   {\ar[Rightarrow,#1]}
\NewDocumentCommand {\pullback} {O{dr}} {\ar[phantom,"\scalebox{1.5}{\(\lrcorner\)}", very near start,#1]}
\NewDocumentCommand {\asc}      {smomo}
  {\ar[#2,"\IfValueT{#3}{#3 \otimes} \alpha_{#4}\IfBooleanT{#1}{^{-1}} \IfValueT{#5}{\otimes #5}"]}
\NewDocumentCommand {\iasc}     {smomo}
  {\ar[#2,"\IfValueT{#3}{{\id[#3]} \otimes} \alpha_{#4}\IfBooleanT{#1}{^{-1}} \IfValueT{#5}{\otimes {\id[#5]}}"]}

% Better spacing for coloured maths
\makeatletter
\def\mathcolor#1#{\@mathcolor{#1}}
\def\@mathcolor#1#2#3{%
  \protect\leavevmode
  \begingroup
  \color#1{#2}#3%
  \endgroup
}
\makeatother

% Colours for distinguishing things
\definecolor{emph1}{HTML}{b751b6}
\definecolor{emph2}{HTML}{4078f2}
\definecolor{emph3}{HTML}{50a14f}
\colorlet{bgB}{cyan!5}
\colorlet{bgY}{yellow!15}
\colorlet{bgG}{green!5}
\NewDocumentCommand {\cI}   {m} {\mathcolor{emph1}{#1}}
\NewDocumentCommand {\cII}  {m} {\mathcolor{emph2}{#1}}
\NewDocumentCommand {\cIII} {m} {\mathcolor{emph3}{#1}}
